version: '3.8'

services:
  # ============================================
  # Tabula Rasa Agent - Main Application
  # ============================================
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: graphiti-lapa-agent
    ports:
      - "3000:3000"  # API endpoint
    env_file:
      - .env
    volumes:
      # Mount code for live updates during development
      - ./agent:/app/agent
      - ./clients:/app/clients
      - ./routers:/app/routers
      - ./config:/app/config
      - ./models:/app/models
      - ./utils:/app/utils
      - ./db:/app/db
      # Mount .env for prompt updates without rebuild
      - ./.env:/app/.env
      # Mount start.py for quick updates
      - ./start.py:/app/start.py
    # Production mode: multi-workers (используется CMD из Dockerfile - start.py)
    # Development mode: single worker с --reload (раскомментировать строку ниже)
    # command: uvicorn app:app --host 0.0.0.0 --port 3000 --reload
    depends_on:
      qdrant:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - graphiti-network
    restart: unless-stopped
    # Для доступу до host machine (vLLM, embedder)
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ============================================
  # Qdrant - Vector Database
  # ============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: graphiti-lapa-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - graphiti-network
    restart: unless-stopped

volumes:
  qdrant_data:
    driver: local

networks:
  graphiti-network:
    driver: bridge
