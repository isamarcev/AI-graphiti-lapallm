version: '3.8'

services:
  # ============================================
  # Phoenix - Observability та Tracing
  # ============================================
  phoenix:
    image: arizephoenix/phoenix:latest
    container_name: graphiti-lapa-phoenix
    ports:
      - "6006:6006"  # Phoenix Web UI
    environment:
      - PHOENIX_PORT=6006
      - PHOENIX_WORKING_DIR=/phoenix
    volumes:
      - phoenix_data:/phoenix
    networks:
      - graphiti-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:6006/healthz').read()"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 40s

  # ============================================
  # Tabula Rasa Agent - Main Application
  # ============================================
  agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: graphiti-lapa-agent
    ports:
      - "3000:3000"  # API endpoint
    env_file:
      - .env
    environment:
      # Phoenix observability
      - ENABLE_PHOENIX=true
      - PHOENIX_COLLECTOR_ENDPOINT=http://phoenix:6006
      - PHOENIX_PROJECT_NAME=graphiti-lapa-agent
    volumes:
      # Mount code for live updates during development
      - ./agent:/app/agent
      - ./clients:/app/clients
      - ./routers:/app/routers
      - ./config:/app/config
      - ./models:/app/models
      - ./utils:/app/utils
      - ./db:/app/db
      # Mount .env for prompt updates without rebuild
      - ./.env:/app/.env
    command: uvicorn app:app --host 0.0.0.0 --port 3000 --reload
    depends_on:
      qdrant:
        condition: service_started
      phoenix:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    networks:
      - graphiti-network
    restart: unless-stopped
    # Для доступу до host machine (vLLM, embedder)
    extra_hosts:
      - "host.docker.internal:host-gateway"

  # ============================================
  # Qdrant - Vector Database
  # ============================================
  qdrant:
    image: qdrant/qdrant:latest
    container_name: graphiti-lapa-qdrant
    ports:
      - "6333:6333"  # REST API
      - "6334:6334"  # gRPC
    volumes:
      - qdrant_data:/qdrant/storage
    networks:
      - graphiti-network
    restart: unless-stopped

volumes:
  phoenix_data:
    driver: local
  qdrant_data:
    driver: local

networks:
  graphiti-network:
    driver: bridge
